<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>AviDaVinci's Limited Event!</title>
        <script type="text/javascript" src="/AviDaVinci-s-Limited-Event/script.js" defer></script>
        <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
        <script src="https://supereggbert.github.io/aframe-htmlembed-component/dist/build.js"></script>
        <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>

        <audio id="qAccept">
            <source src="resources/FFXIV_Quest_Accepted.mp3" type="audio/mp3">
        </audio>
        <audio id="qDecline">
            <source src="resources/FFXIV_Cancel.mp3" type="audio/mp3">
        </audio>
        <audio id="mOver">
            <source src="resources/FFXIV_Switch_Target.mp3" type="audio/mp3">
        </audio>
        <audio id="buttClick">
            <source src="resources/FFXIV_Confirm.mp3" type="audio/mp3">
        </audio>
        <audio id="qComplete">
            <source src="resources/FFXIV_Quest_Complete.mp3" type="audio/mp3">
        </audio>
        <audio id="oWindow">
            <source src="resources/FFXIV_Open_Window.mp3" type="audio/mp3">
        </audio>
    </head>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        #QWindow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        #QWindow img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
    </style>

    <script>
        AFRAME.registerComponent('accept', {
            init: function () {
            var data = this.data;
            var el = this.el;
            },

            events: {
                mouseenter: function (evt){
                    mOverSFX();
                },

                click: function (evt){
                    buttAccept();
                }
            }
        });

        AFRAME.registerComponent('decline', {
            init: function () {
            var data = this.data;
            var el = this.el;
            },

            events: {
                mouseenter: function (evt){
                    mOverSFX();
                },

                click: function (evt){
                    var qw = document.querySelector("#qwImage");
                    qw.setAttribute("visible", false);
                    declineQuest();
                    compRemoval();
                }
            }
        });

        AFRAME.registerComponent('shake', {
        init: function () {
            window.addEventListener('devicemotion', this.onDeviceMotion.bind(this));
            },
        onDeviceMotion: function (event) {
            // Get the acceleration including gravity from the DeviceMotionEvent
            var acceleration = event.accelerationIncludingGravity;

            // Calculate the total acceleration
            var totalAcceleration = Math.sqrt(
            Math.pow(acceleration.x, 2) +
            Math.pow(acceleration.y, 2) +
            Math.pow(acceleration.z, 2)
            );

            // Check if the total acceleration is above a certain threshold
            if (totalAcceleration > 30) {
                // Trigger an event or update the scene here
                var qw = document.querySelector("#qwImage"); 
                if(qw.object3D.visible == false){
                    qw.setAttribute("visible", true);
                    compAcquisition();
                    openWindow();
                }
                else{};
                }
            }
        });
    </script>

    <body>
        <!-- <div id="QWindow">
            <img src="resources/questWindow.png">
        </div> -->
        <a-scene 
         shake
         vr-mode-ui="enabled: false"
         cursor="rayOrigin: mouse; fuse: false" 
         raycaster="objects: .raycastable">
            <a-assets>
                <img id="QWindow" src="resources/questWindow.png">
                <img id="moogle" src="resources/GIF.gif">
                <img id="sky" src="resources/skyMoon.jpg">
            </a-assets>
            <!-- <a-sky color="#1B1B1B"></a-sky> -->
            <a-sky src="#sky" phi-start="-90"></a-sky>

            <a-image id="qwImage" src="#QWindow" width="0.84" height="1" visible="false" look-at="#camera">
                <a-plane id="accept" 
                class="raycastable"
                transparent="true"
                opacity="0.5"
                height="0.035" width="0.225" 
                position="-0.150, -0.325, 0.001" 
                material="color: #ff000000; side: double; wireframe: true"></a-plane>

                <a-plane id="decline" 
                class="raycastable"
                transparent="true"
                opacity="0.5"
                height="0.035" width="0.225" 
                position="0.150, -0.325, 0.001" 
                material="color: #ff000000; side: double; wireframe: true"></a-plane>
            </a-image>

            <a-text billboard id="followText" value="Shake me!" color="white" font="kelsonsans"></a-text>

            <a-image id="NPC" src="#moogle" width="0.56" height="1" position="0, 0, -2" look-at="#camera">
                <!-- next up is to make a dialogue function + Quest Accepted popup -->
            </a-image>

            <a-entity id="rig" position="0 -1.6 1">
                <a-camera look-controls wasd-controls-enabled="false" id="camera"></a-camera>
            </a-entity>
        </a-scene>
    </body>

    <script>
        var textEl = document.querySelector('#followText');
        var cameraEl = document.querySelector('#camera');

        AFRAME.registerComponent('billboard', {
        tick: function () {
            // Get the camera's rotation
            var cameraRotation = cameraEl.getAttribute('rotation');

            // Update the text's rotation to face the camera
            textEl.setAttribute('rotation', {
            x: 0,
            y: cameraRotation.y,
            z: 0
            });

            // Get the camera's position
            var cameraPosition = cameraEl.getAttribute('position');

            // Calculate the text's position based on the camera's position and rotation
            var textPosition = {
            x: cameraPosition.x - Math.sin(cameraRotation.y * Math.PI / 180) * 2,
            y: 0 - Math.tan(cameraRotation.y * Math.PI / 180),
            z: cameraPosition.z - Math.cos(cameraRotation.y * Math.PI / 180) * 2
            };

            // Update the text's position
            textEl.setAttribute('position', textPosition);
        }
        });

        textEl.setAttribute('billboard', '');
    </script>
</html>